{% extends "base.html" %}

{% block title %}Control {{ robot.name }} - JoJo AsisTECH{% endblock %}

{% block head_css %}
    <style>
        .control-container {
            padding: 1.5rem;
            max-width: 100%;
            margin: 0 auto;
        }

        .robot-header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .robot-info h1 {
            margin: 0 0 0.5rem 0;
            color: #1E1228;
            font-size: 1.8rem;
        }

        .robot-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        /* Layout principal: 2 columnas */
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Columna izquierda: Ruedas y Voz */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }

        .left-column .control-panel:last-child {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* Columna derecha: Brazo */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-panel {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .control-panel h2 {
            margin-top: 0;
            color: #1E1228;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #4285f4;
            padding-bottom: 0.8rem;
            font-weight: 700;
        }

        /* Panel de cámara y brazo juntos */
        .camera-arm-container {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 1.5rem;
        }

        .video-feed {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            border: 3px solid #333;
        }

        /* Control de ruedas estilo joystick */
        .wheels-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .direction-buttons {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 0.8rem;
            justify-content: center;
        }

        .direction-btn {
            background: linear-gradient(145deg, #4285f4, #357ae8);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 6px 15px rgba(66, 133, 244, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .direction-btn:hover {
            background: linear-gradient(145deg, #3367d6, #2a5bb8);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4);
        }

        .direction-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(66, 133, 244, 0.3);
        }

        .direction-btn.empty {
            background: transparent;
            box-shadow: none;
            cursor: default;
        }

        .direction-btn.stop {
            background: linear-gradient(145deg, #ea4335, #d93025);
            font-size: 2.5rem;
        }

        .direction-btn.stop:hover {
            background: linear-gradient(145deg, #d93025, #c5221f);
        }

        /* Control del brazo robótico */
        .arm-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .joystick-arm {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 16px;
            border: 3px solid #4285f4;
        }

        .joystick-arm-title {
            font-weight: 700;
            color: #1E1228;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.2rem;
        }

        .joystick-visual {
            width: 200px;
            height: 200px;
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            border-radius: 50%;
            position: relative;
            margin: 0 auto 1.2rem;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.1), 0 6px 16px rgba(0,0,0,0.1);
        }

        .joystick-stick {
            width: 70px;
            height: 70px;
            background: linear-gradient(145deg, #4285f4, #357ae8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 6px 15px rgba(66, 133, 244, 0.5);
            transition: all 0.3s ease;
        }

        .joystick-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            max-width: 240px;
            margin: 0 auto;
        }

        .joystick-btn {
            padding: 1rem;
            background: linear-gradient(145deg, #4285f4, #357ae8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
        }

        .joystick-btn:hover {
            background: linear-gradient(145deg, #3367d6, #2a5bb8);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
        }

        .joystick-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }

        .joystick-btn.empty {
            background: transparent;
            box-shadow: none;
            cursor: default;
        }

        .joystick-values {
            display: flex;
            justify-content: space-around;
            margin-top: 1.2rem;
            padding-top: 1.2rem;
            border-top: 2px solid #ddd;
        }

        .joystick-value-item {
            text-align: center;
        }

        .joystick-value-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .joystick-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4285f4;
        }

        .gripper-control {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 16px;
            border: 3px solid #34a853;
            text-align: center;
            grid-column: 1 / -1;
        }

        .gripper-button {
            width: 100%;
            padding: 2rem;
            background: linear-gradient(145deg, #34a853, #2d8e47);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(52, 168, 83, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .gripper-button:hover {
            background: linear-gradient(145deg, #2d8e47, #1e7e34);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 168, 83, 0.4);
        }

        .gripper-button.closed {
            background: linear-gradient(145deg, #ea4335, #d93025);
        }

        .gripper-button.closed:hover {
            background: linear-gradient(145deg, #d93025, #c5221f);
        }

        .gripper-icon {
            font-size: 3rem;
            transition: transform 0.3s;
        }

        .gripper-button.closed .gripper-icon {
            transform: rotate(45deg);
        }

        /* Botón de micrófono */
        .mic-button {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(145deg, #34a853, #2d8e47);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(52, 168, 83, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.2rem;
        }

        .mic-button:hover {
            background: linear-gradient(145deg, #2d8e47, #1e7e34);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 168, 83, 0.4);
        }

        .mic-button.recording {
            background: linear-gradient(145deg, #ea4335, #d93025);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 6px 15px rgba(234, 67, 53, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(234, 67, 53, 0.6); }
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .action-btn {
            padding: 1.2rem;
            background: linear-gradient(145deg, #34a853, #2d8e47);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: 0 4px 10px rgba(52, 168, 83, 0.2);
            font-weight: 600;
        }

        .action-btn:hover {
            background: linear-gradient(145deg, #2d8e47, #1e7e34);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 168, 83, 0.3);
        }

        .action-btn.emergency {
            background: linear-gradient(145deg, #ea4335, #d93025);
            grid-column: 1 / -1;
        }

        .action-btn.emergency:hover {
            background: linear-gradient(145deg, #d93025, #c5221f);
        }

        .sensor-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .sensor-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .sensor-item label {
            display: block;
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .sensor-item .value {
            font-size: 2rem;
            font-weight: bold;
            color: #1E1228;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .camera-arm-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="control-container">
    <div class="robot-header">
        <div class="robot-info">
            <h1><i class="fa-solid fa-robot"></i> {{ robot.name }}</h1>
            <p style="color: #666; margin: 0; font-size: 1.1rem;">Serie: {{ robot.serial_number }}</p>
        </div>
        <div class="robot-status">
            {% if robot.is_online %}
                <span class="status-badge status-online">
                    <i class="fa-solid fa-circle"></i> EN LÍNEA
                </span>
            {% else %}
                <span class="status-badge status-offline">
                    <i class="fa-solid fa-circle"></i> DESCONECTADO
                </span>
            {% endif %}
            <a href="{{ url_for('robot.select') }}" class="action-btn" style="text-decoration: none; padding: 0.8rem 1.5rem; background: linear-gradient(145deg, #666, #555);">
                <i class="fa-solid fa-arrow-left"></i> VOLVER
            </a>
        </div>
    </div>

    <div class="main-layout">
        <!-- COLUMNA IZQUIERDA: Control de Ruedas y Voz -->
        <div class="left-column">
            <!-- Control de Ruedas -->
            <div class="control-panel">
                <h2><i class="fa-solid fa-car"></i> CONTROL DE RUEDAS</h2>
                <div class="wheels-control">
                    <div class="direction-buttons">
                        <div class="direction-btn empty"></div>
                        <button class="direction-btn" data-direction="forward" title="Adelante">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                        <div class="direction-btn empty"></div>
                        
                        <button class="direction-btn" data-direction="left" title="Izquierda">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <button class="direction-btn stop" data-direction="stop" title="Detener">
                            <i class="fa-solid fa-stop"></i>
                        </button>
                        <button class="direction-btn" data-direction="right" title="Derecha">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        
                        <div class="direction-btn empty"></div>
                        <button class="direction-btn" data-direction="backward" title="Atrás">
                            <i class="fa-solid fa-arrow-down"></i>
                        </button>
                        <div class="direction-btn empty"></div>
                    </div>
                </div>
            </div>

            <!-- Control de Voz -->
            <div class="control-panel">
                <h2><i class="fa-solid fa-microphone"></i> CONTROL DE VOZ</h2>
                <button class="mic-button" id="micButton">
                    <i class="fa-solid fa-microphone" style="font-size: 2rem;"></i>
                    <span id="micText" style="font-size: 1.3rem; font-weight: 700;">MANTÉN PRESIONADO PARA HABLAR</span>
                </button>
                <div id="transcription" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem; border-radius: 12px; color: #666; font-style: italic; font-size: 1.1rem; border: 2px solid #dee2e6; margin-top: 1rem; flex: 1; display: flex; align-items: flex-start; justify-content: flex-start; overflow-y: auto;">
                    La transcripción aparecerá aquí...
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: Brazo y Cámara -->
        <div class="right-column">
            <!-- Control del Brazo -->
            <div class="control-panel">
            <h2><i class="fa-solid fa-hand-back-fist"></i> CONTROL DEL BRAZO ROBÓTICO</h2>
                <div class="arm-controls">
                    <!-- Joystick 1: Base y Hombro -->
                    <div class="joystick-arm">
                        <div class="joystick-arm-title">
                            <i class="fa-solid fa-gamepad"></i> JOYSTICK 1 - Base & Hombro
                        </div>
                        <div class="joystick-visual" id="joystick1Visual" style="cursor: pointer;" title="Haz clic y arrastra para controlar">
                            <div class="joystick-stick" id="joystick1Stick"></div>
                        </div>
                        <div class="joystick-values">
                            <div class="joystick-value-item">
                                <div class="joystick-value-label">Base</div>
                                <div class="joystick-value" id="baseValue">90°</div>
                            </div>
                            <div class="joystick-value-item">
                                <div class="joystick-value-label">Hombro</div>
                                <div class="joystick-value" id="shoulderValue">90°</div>
                            </div>
                        </div>
                    </div>

                    <!-- Joystick 2: Codo -->
                    <div class="joystick-arm">
                        <div class="joystick-arm-title">
                            <i class="fa-solid fa-gamepad"></i> JOYSTICK 2 - Codo
                        </div>
                        <div class="joystick-visual" id="joystick2Visual" style="cursor: pointer;" title="Haz clic y arrastra para controlar">
                            <div class="joystick-stick" id="joystick2Stick"></div>
                        </div>
                        <div class="joystick-values">
                            <div class="joystick-value-item">
                                <div class="joystick-value-label">Codo</div>
                                <div class="joystick-value" id="elbowValue">90°</div>
                            </div>
                        </div>
                    </div>

                    <!-- Control de Pinza -->
                    <div class="gripper-control">
                        <div class="joystick-arm-title">
                            <i class="fa-solid fa-hand-scissors"></i> CONTROL DE PINZA
                        </div>
                        <button class="gripper-button" id="gripperButton" data-state="open">
                            <div class="gripper-icon">✂️</div>
                            <div>
                                <div style="font-size: 1.6rem; font-weight: bold;" id="gripperText">ABRIR</div>
                                <div style="font-size: 1.1rem; opacity: 0.9;" id="gripperAngle">0°</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Botón de reset -->
                <button class="action-btn" id="resetArm" style="background: linear-gradient(145deg, #fbbc04, #f9ab00); margin-top: 1.5rem; padding: 1.5rem; font-size: 1.2rem;">
                    <i class="fa-solid fa-rotate-left"></i> RESETEAR TODO (Posición Inicial)
                </button>
            </div>
        </div>
    </div>

    <!-- Cámara Centrada -->
    <div style="max-width: 800px; margin: 2rem auto;">
        <div class="control-panel">
            <h2 style="text-align: center;"><i class="fa-solid fa-video"></i> CÁMARA EN VIVO</h2>
            <div class="video-feed" id="videoContainer">
                <div style="text-align: center;" id="videoPlaceholder">
                    <i class="fa-solid fa-video-slash" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.3rem; font-weight: 600;">Cámara desconectada</p>
                    <small style="color: #888; font-size: 1rem;">ESP32-CAM en 192.168.1.103</small>
                </div>
                <img id="videoStream" src="" alt="Stream de video" style="display: none; width: 100%; border-radius: 12px;">
            </div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="action-btn" id="toggleCameraBtn" style="background: linear-gradient(145deg, #34a853, #2d8e47); padding: 1.5rem 3rem; font-size: 1.3rem; width: 100%;">
                    <i class="fa-solid fa-play"></i> INICIAR CÁMARA
                </button>
                <div id="streamTimer" style="margin-top: 1rem; font-size: 1.5rem; font-weight: 700; color: #34a853; display: none;">
                    <i class="fa-solid fa-clock"></i> Tiempo: <span id="timerValue">00:00</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
    <script src="{{ url_for('static', filename='js/robot_control.js') }}"></script>
    <script>
        // Pasar el ID del robot al JavaScript
        const ROBOT_ID = {{ robot.id }};
        const MQTT_TOPIC = "{{ robot.mqtt_topic }}";
        
        // Control de cámara con temporizador
        let cameraActive = false;
        let streamTimer = null;
        let streamSeconds = 0;
        const ESP32_CAM_URL = "http://192.168.1.103:81/stream";
        
        document.getElementById('toggleCameraBtn').addEventListener('click', function() {
            const btn = this;
            const videoStream = document.getElementById('videoStream');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const timerDisplay = document.getElementById('streamTimer');
            const timerValue = document.getElementById('timerValue');
            
            if (!cameraActive) {
                // Iniciar cámara
                videoStream.src = ESP32_CAM_URL;
                videoStream.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                timerDisplay.style.display = 'block';
                
                btn.innerHTML = '<i class="fa-solid fa-stop"></i> DETENER CÁMARA';
                btn.style.background = 'linear-gradient(145deg, #ea4335, #d33426)';
                
                // Iniciar contador
                streamSeconds = 0;
                streamTimer = setInterval(() => {
                    streamSeconds++;
                    const minutes = Math.floor(streamSeconds / 60).toString().padStart(2, '0');
                    const seconds = (streamSeconds % 60).toString().padStart(2, '0');
                    timerValue.textContent = `${minutes}:${seconds}`;
                }, 1000);
                
                cameraActive = true;
            } else {
                // Detener cámara
                videoStream.src = '';
                videoStream.style.display = 'none';
                videoPlaceholder.style.display = 'block';
                timerDisplay.style.display = 'none';
                
                btn.innerHTML = '<i class="fa-solid fa-play"></i> INICIAR CÁMARA';
                btn.style.background = 'linear-gradient(145deg, #34a853, #2d8e47)';
                
                // Detener contador
                if (streamTimer) {
                    clearInterval(streamTimer);
                    streamTimer = null;
                }
                streamSeconds = 0;
                
                cameraActive = false;
            }
        });
    </script>
{% endblock %}
